<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="articleMapper">

	<insert id="articleWrite" parameterType="articleVO" useGeneratedKeys="true" keyColumn="ano" keyProperty="ano">
		<selectKey keyProperty="ano" resultType="int" order="BEFORE">
			SELECT E_ARTICLE_SEQ.NEXTVAL AS ano FROM DUAL
		</selectKey>
		
		INSERT INTO E_ARTICLE ( 
			ANO,
		    ATITLE,
			ACONTENT,
			AWRITER,
			ACATEGORYNO,
			ACATEGORYNOREF,
			AINSERTDATE,
			AINSERTIP,
			AINSERTID
		) VALUES (
			#{ano},
			#{atitle},
			#{acontent},
			#{awriter},
			#{acategoryno},
			#{acategorynoref},
			SYSDATE,
			#{ainsertip},
			#{ainsertid}
		)
	</insert>
	
	<!--  
	<select id="articleList" resultType="articleVO">
		SELECT * FROM E_ARTICLE
		ORDER BY ANO DESC
	</select>
	-->

	<select id="articleList" resultType="articleVO" parameterType="searchCriteria">
		SELECT 
		    ANO,
		    ACATEGORYNO,
		    ACATEGORYNOREF,
		    ATITLE,
		    ACONTENT,
		    AWRITER,
		    AINSERTDATE,
		    AVIEWCNT
		FROM (
		    SELECT 
		        ANO,
		        ACATEGORYNO,
		        ACATEGORYNOREF,
		        ATITLE,
		        ACONTENT,
		        AWRITER,
		        AINSERTDATE,
		        AVIEWCNT,
		        ROW_NUMBER() OVER(ORDER BY ANO DESC) AS RNUM
		    FROM E_ARTICLE
		    WHERE 1 = 1
		    <include refid="search"></include>
		) E
		WHERE RNUM BETWEEN #{rowStart} AND #{rowEnd}
		ORDER BY ANO DESC
	</select>
	
	<select id="articleListCount" parameterType="searchCriteria" resultType="int">
		SELECT COUNT(ANO) FROM E_ARTICLE
		WHERE 1 = 1
		<include refid="search"></include>
		AND ANO > 0
	</select>
	
	<sql id="search">
		<if test="searchType != null">
			<if test="searchType == 't'.toString()">AND ATITLE LIKE '%' || #{keyword} || '%'</if>
			<if test="searchType == 'c'.toString()">AND ACONTENT LIKE '%' || #{keyword} || '%'</if>
			<if test="searchType == 'w'.toString()">AND AWRITER LIKE '%' || #{keyword} || '%'</if>
			<if test="searchType == 'tc'.toString()">AND (ATITLE LIKE '%' || #{keyword} || '%') or (ACONTENT LIKE '%' || #{keyword} || '%')</if>
		</if>
		
		<if test="searchDate != null || searchDate != all">
			<!-- all, 1d, 1w, 1m, 6m, 1y -->
			<if test="searchDate == '1d'.toString()">
				AND AINSERTDATE BETWEEN TO_DATE(TO_CHAR(SYSDATE -1, 'YYYYMMDD'), 'YYYYMMDD')
				AND TO_DATE(TO_CHAR(SYSDATE, 'YYYYMMDD') + 1, 'YYYYMMDD')
			</if>
			<if test="searchDate == '1w'.toString()">
				AND AINSERTDATE BETWEEN TO_DATE(TO_CHAR(SYSDATE -7, 'YYYYMMDD'), 'YYYYMMDD')
				AND TO_DATE(TO_CHAR(SYSDATE, 'YYYYMMDD') + 1, 'YYYYMMDD')
			</if>
			<if test="searchDate == '1m'.toString()">
				AND AINSERTDATE BETWEEN TO_DATE(TO_CHAR(ADD_MONTHS(SYSDATE, -1), 'YYYYMMDD'), 'YYYYMMDD')
				AND TO_DATE(TO_CHAR(SYSDATE, 'YYYYMMDD') + 1, 'YYYYMMDD')
			</if>
			<if test="searchDate == '6m'.toString()">
				AND AINSERTDATE BETWEEN TO_DATE(TO_CHAR(ADD_MONTHS(SYSDATE, -6), 'YYYYMMDD'), 'YYYYMMDD')
				AND TO_DATE(TO_CHAR(SYSDATE, 'YYYYMMDD') + 1, 'YYYYMMDD')
			</if>	
			<if test="searchDate == '1y'.toString()">
				AND AINSERTDATE BETWEEN TO_DATE(TO_CHAR(ADD_MONTHS(SYSDATE, -12), 'YYYYMMDD'), 'YYYYMMDD')
				AND TO_DATE(TO_CHAR(SYSDATE, 'YYYYMMDD') + 1, 'YYYYMMDD')
			</if>						
		</if>
	</sql>
	
	<select id="articleView" resultType="articleVO">
		SELECT * FROM E_ARTICLE
		WHERE ANO = #{ano}
	</select>

	<select id="getLike" resultType="int">
		SELECT COUNT(LNO) FROM E_ARTICLE_LIKE
		WHERE ANO = #{ano}
	</select>
	
	<select id="checkLike" resultType="int">
		SELECT COUNT(LNO) FROM E_ARTICLE_LIKE
		WHERE ANO = #{ano}
		AND   MID = #{mid}
	</select>
	
	<insert id="addLike">
		INSERT INTO E_ARTICLE_LIKE (
			LNO,
			ANO,
			MID
		) VALUES (
			E_ARTICLE_LIKE_SEQ.NEXTVAL,
			#{ano},
			#{mid}
		)
	</insert>
	
	<delete id="removeLike">
		DELETE FROM E_ARTICLE_LIKE 
		WHERE MID = #{mid}
	</delete>
	
	<update id="viewCountUp">
		UPDATE E_ARTICLE SET 
		AVIEWCNT = (AVIEWCNT + 1)
		WHERE ANO = #{ano}
	</update>

	<insert id="writeComment">
		INSERT INTO E_COMMENT (
			CNO,
		    ANO,
		    CCONTENT,
		    CWRITER,
		    CINSERTIP,
		    CINSERTID
		) VALUES (
			E_COMMENT_SEQ.NEXTVAL,
			#{ano},
			#{ccontent},
			#{cwriter},
			#{cinsertip},
			#{cwriter}
		)
	</insert>
	
	<select id="commentList" resultType="commentVO">
		SELECT 
		    CNO,
		    PCNO,
		    ANO,
		    LEVEL COMMENTLEVEL,
		    CCONTENT,
		    CWRITER,
		    CINSERTDATE 
		FROM (
		    SELECT 
		        CNO,
		        PCNO,
		        ANO,
		        CCONTENT,
		        CWRITER,
		        CINSERTDATE,
		        ROW_NUMBER() OVER(ORDER BY CNO DESC) AS RNUM
		    FROM E_COMMENT
		    WHERE ANO = 1
		    AND CDELETEYN = 'N'
		) 
		WHERE RNUM BETWEEN 1 AND 10
		START WITH PCNO = 0
		CONNECT BY PRIOR CNO = PCNO
		ORDER SIBLINGS BY CNO DESC;
	</select>
	
	<select id="commentListCount" resultType="int">
		SELECT COUNT(CNO) FROM E_COMMENT
		WHERE CNO > 0
	</select>

</mapper>